# PAG 文件复杂度分析工具使用说明

## 功能说明

我已经创建了一个 PAG 文件复杂度分析工具，用于检查 PAG 文件的复杂度，帮助诊断性能问题。

## 自动分析

在 Debug 模式下，应用启动 1 秒后会自动分析 `loading_1.pag` 和 `loading_2.pag` 文件，并在控制台输出详细报告。

## 分析内容

工具会分析以下指标：

1. **文件大小**：文件占用的存储空间
2. **尺寸**：动画的宽度和高度
3. **时长**：动画播放时长（秒）
4. **帧率**：动画帧率（fps）
5. **总帧数**：动画总帧数
6. **图层数量**：PAG 文件包含的图层数量（**重要指标**）
7. **复杂度评分**：综合评分（0-100），越高越复杂

## 复杂度评分标准

评分基于以下因素：

- **文件大小**：
  - > 500KB: +20 分
  - > 100KB: +10 分
  - > 10KB: +5 分

- **图层数量**（主要因素）：
  - > 50 个: +30 分
  - > 20 个: +20 分
  - > 10 个: +10 分
  - > 5 个: +5 分

- **分辨率**：
  - > 1080p: +25 分
  - > 720p: +15 分
  - > 480p: +10 分

- **帧率**：
  - > 60fps: +15 分
  - > 30fps: +10 分

- **时长**：
  - > 5 秒: +10 分
  - > 2 秒: +5 分

## 复杂度等级

- **0-30 分**：简单 ⭐（性能应该很好）
- **30-60 分**：中等 ⭐⭐（需要预热优化）
- **60-80 分**：复杂 ⭐⭐⭐（需要充分预热）
- **80-100 分**：非常复杂 ⭐⭐⭐⭐（可能需要优化文件本身）

## 当前文件信息

根据文件系统信息：
- `loading_1.pag`: 1.4 KB
- `loading_2.pag`: 1.6 KB

文件大小很小，说明文件本身应该不复杂。但如果 FPS 仍然降到 39，可能的原因：

1. **图层数量过多**：即使文件小，如果图层多也会影响性能
2. **GPU 初始化延迟**：第一次渲染时需要初始化 GPU 环境
3. **预热不充分**：虽然已经做了预热，但可能还需要更多

## 查看分析结果

运行应用后，在 Xcode 控制台查看输出，会看到类似这样的报告：

```
📊 PAG 文件复杂度分析报告
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
文件路径: /path/to/loading_1.pag
文件大小: 1.40 KB
尺寸: 90 × 40
时长: 1.00 秒
帧率: 30 fps
总帧数: 30 帧
图层数量: 5 个
包含视频: 否
包含音频: 否
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
复杂度评分: 15/100
复杂度等级: 简单 ⭐

💡 性能建议:
✓ 复杂度较低，性能应该良好
```

## 手动分析

如果需要手动分析其他 PAG 文件，可以使用：

```objc
// 分析 Bundle 中的文件
PAGFileComplexityInfo *info = [PAGFileAnalyzer analyzeFileInBundle:@"loading_1"];
if (info) {
    NSLog(@"%@", [info generateReport]);
}

// 分析指定路径的文件
PAGFileComplexityInfo *info = [PAGFileAnalyzer analyzeFileAtPath:@"/path/to/file.pag"];
if (info) {
    NSLog(@"%@", [info generateReport]);
}
```

## 性能优化建议

根据分析结果：

### 如果复杂度评分 < 30（简单）
- 当前预热策略应该足够
- 如果仍有卡顿，可能是 GPU 初始化问题，可以增加预热帧数

### 如果复杂度评分 30-60（中等）
- 需要充分预热（当前已实现）
- 可以考虑在应用启动时提前创建 PAGView 实例

### 如果复杂度评分 > 60（复杂）
- 建议优化 PAG 文件本身：
  - 减少图层数量
  - 简化动画效果
  - 降低分辨率（如果不需要高分辨率）
  - 减少不必要的效果和滤镜

## 下一步

1. **运行应用**，查看控制台输出的分析报告
2. **检查图层数量**：如果图层数量 > 20，可能是主要性能瓶颈
3. **根据报告调整优化策略**：
   - 如果复杂度低但仍有卡顿 → 增加预热
   - 如果复杂度高 → 考虑优化 PAG 文件

## 注意事项

- 分析工具仅在 **Debug 模式**下可用
- 分析会在应用启动 1 秒后自动执行（避免影响启动性能）
- 如果文件加载失败，会在控制台输出警告信息
